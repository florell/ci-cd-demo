# GitLab CI/CD Pipeline Configuration
# Includes both CI (static analysis + tests) and CD (Docker build + push)

stages:
  - lint
  - test
  - build
  - deploy

variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE
  DOCKER_TLS_CERTDIR: "/certs"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Cache configuration
cache:
  paths:
    - .cache/pip
    - venv/

# ===================
# CI PIPELINE (1 балл)
# ===================

# Static Analysis Jobs
black:
  stage: lint
  image: python:3.11-slim
  script:
    - pip install black
    - black --check --diff app/ tests/
  allow_failure: true
  tags:
    - docker

isort:
  stage: lint
  image: python:3.11-slim
  script:
    - pip install isort
    - isort --check-only --diff app/ tests/
  allow_failure: true
  tags:
    - docker

flake8:
  stage: lint
  image: python:3.11-slim
  script:
    - pip install flake8
    - flake8 app/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
    - flake8 app/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics
  tags:
    - docker

pylint:
  stage: lint
  image: python:3.11-slim
  script:
    - pip install pylint flask
    - pylint app/ --exit-zero --max-line-length=100 --disable=C0114,C0115,C0116
  allow_failure: true
  tags:
    - docker

mypy:
  stage: lint
  image: python:3.11-slim
  script:
    - pip install mypy flask
    - mypy app/ --ignore-missing-imports || true
  allow_failure: true
  tags:
    - docker

bandit:
  stage: lint
  image: python:3.11-slim
  script:
    - pip install bandit
    - bandit -r app/ -ll --exit-zero
  allow_failure: true
  tags:
    - docker

# Unit Tests
test:python3.10:
  stage: test
  image: python:3.10-slim
  script:
    - pip install -r requirements-dev.txt
    - pytest tests/ -v --cov=app --cov-report=xml --cov-report=term-missing
  coverage: '/TOTAL.+ ([0-9]{1,3}%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week
  tags:
    - docker

test:python3.11:
  stage: test
  image: python:3.11-slim
  script:
    - pip install -r requirements-dev.txt
    - pytest tests/ -v --cov=app --cov-report=xml --cov-report=term-missing
  coverage: '/TOTAL.+ ([0-9]{1,3}%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week
  tags:
    - docker

test:python3.12:
  stage: test
  image: python:3.12-slim
  script:
    - pip install -r requirements-dev.txt
    - pytest tests/ -v --cov=app --cov-report=xml --cov-report=term-missing
  coverage: '/TOTAL.+ ([0-9]{1,3}%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week
  tags:
    - docker

# ===================
# CD PIPELINE (1 балл)
# ===================

# Build Docker Image
build:docker:
  stage: build
  image: docker:24.0.7
  services:
    - docker:24.0.7-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $DOCKER_IMAGE:$CI_COMMIT_SHA .
    - docker build -t $DOCKER_IMAGE:$CI_COMMIT_REF_SLUG .
    - docker push $DOCKER_IMAGE:$CI_COMMIT_SHA
    - docker push $DOCKER_IMAGE:$CI_COMMIT_REF_SLUG
  only:
    - main
    - develop
    - tags
  tags:
    - docker

# Build and Push Latest Tag (only on main)
build:latest:
  stage: build
  image: docker:24.0.7
  services:
    - docker:24.0.7-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $DOCKER_IMAGE:latest .
    - docker push $DOCKER_IMAGE:latest
  only:
    - main
  tags:
    - docker

# Build and Push to Docker Hub (optional)
build:dockerhub:
  stage: build
  image: docker:24.0.7
  services:
    - docker:24.0.7-dind
  before_script:
    - docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_TOKEN
  script:
    - docker build -t $DOCKERHUB_USERNAME/ci-cd-demo:$CI_COMMIT_SHA .
    - docker build -t $DOCKERHUB_USERNAME/ci-cd-demo:$CI_COMMIT_REF_SLUG .
    - docker push $DOCKERHUB_USERNAME/ci-cd-demo:$CI_COMMIT_SHA
    - docker push $DOCKERHUB_USERNAME/ci-cd-demo:$CI_COMMIT_REF_SLUG
    - |
      if [ "$CI_COMMIT_REF_NAME" == "main" ]; then
        docker tag $DOCKERHUB_USERNAME/ci-cd-demo:$CI_COMMIT_SHA $DOCKERHUB_USERNAME/ci-cd-demo:latest
        docker push $DOCKERHUB_USERNAME/ci-cd-demo:latest
      fi
  only:
    - main
    - tags
  when: manual
  tags:
    - docker

# Semantic Version Tagging
build:release:
  stage: build
  image: docker:24.0.7
  services:
    - docker:24.0.7-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $DOCKER_IMAGE:$CI_COMMIT_TAG .
    - docker push $DOCKER_IMAGE:$CI_COMMIT_TAG
  only:
    - tags
  tags:
    - docker

# Deploy Stage (example - can be customized)
deploy:staging:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploying to staging environment..."
    - echo "Image: $DOCKER_IMAGE:$CI_COMMIT_SHA"
    # Add your deployment commands here
    # Example: kubectl set image deployment/app app=$DOCKER_IMAGE:$CI_COMMIT_SHA
  environment:
    name: staging
    url: https://staging.example.com
  only:
    - develop
  when: manual
  tags:
    - docker

deploy:production:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploying to production environment..."
    - echo "Image: $DOCKER_IMAGE:$CI_COMMIT_SHA"
    # Add your deployment commands here
  environment:
    name: production
    url: https://example.com
  only:
    - main
  when: manual
  tags:
    - docker
